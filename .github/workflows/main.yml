name: Deploy XaaS Ops Environment

on:
  workflow_dispatch:
    
jobs:
  deploy-mlz:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
        with:
          repository: Azure/missionlz
      - uses: azure/Login@v1
        with:
          creds: ${{secrets.AZURE_CREDENTIALS}}
          environment: 'AzureUSGovernment'
      - name: Deploy Mission Landing Zone
        run: |
          az deployment sub create \
            --name myMlzDeployment-${{ github.run_number }} \
            --location usgovvirginia \
            --template-file ./src/bicep/mlz.bicep \
            --parameters \
              resourcePrefix="tmlz${{ github.run_number }}" \
              deployPolicy="true" \
              policy="IL5"

      - name: Deploy Tier3 Workload Spoke
        run: |
          cd add-ons
          az deployment sub show \
            --name myMlzDeployment-${{ github.run_number }} \
            --query properties.outputs > ./deploymentVariables.json

          cd tier3
          az deployment sub create \
            -n myMlzDeploymentTier3-${{ github.run_number }} \
            -f tier3.bicep \
            -l usgovvirginia \
            --parameters \
              resourcePrefix="tmlzt3${{ github.run_number }}"